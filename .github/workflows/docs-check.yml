name: Documentation Check

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # mainãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«å…¨å±¥æ­´ã‚’å–å¾—
          fetch-depth: 0

      - name: Fetch main branch
        run: git fetch origin main:main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run documentation code validation
        run: npm run validate:docs:code

      - name: Check documentation updates
        id: check-docs
        run: |
          echo "Running documentation update check..."
          npm run validate:docs:update -- --verbose > /tmp/docs-update-check.log 2>&1 || true
          cat /tmp/docs-update-check.log

          # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæœªæ›´æ–°ã®è­¦å‘Šã‚’æ¤œå‡º
          if grep -q "âš ï¸  ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯æ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“" /tmp/docs-update-check.log; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’æŠ½å‡º
            sed -n '/ðŸ“ ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™:/,/^$/p' /tmp/docs-update-check.log > /tmp/changed-files.txt
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR if docs need update
        if: steps.check-docs.outputs.needs_update == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changedFiles = fs.existsSync('/tmp/changed-files.txt') 
              ? fs.readFileSync('/tmp/changed-files.txt', 'utf8')
              : '';

            const body = `## âš ï¸ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã®ç¢ºèª

            ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯æ›´æ–°ã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚

            ${changedFiles}

            ### ðŸ’¡ å¯¾å¿œæ–¹æ³•
            - **é‡è¦ãªå¤‰æ›´ã®å ´åˆ**: Claudeã‚³ãƒžãƒ³ãƒ‰\`update-docs\`ã‚’å®Ÿè¡Œã—ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¦ãã ã•ã„
            - **è»½å¾®ãªå¤‰æ›´ã‚„å†…éƒ¨å®Ÿè£…ã®å¤‰æ›´ã®å ´åˆ**: æ›´æ–°ä¸è¦ã§ã™

            ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚`;

            // æ—¢å­˜ã®botã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('âš ï¸ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã®ç¢ºèª')
            );

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Œã°æ›´æ–°ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆ
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Post validation summary
        if: always()
        run: |
          echo "## ðŸ“š Documentation Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Validations Completed:" >> $GITHUB_STEP_SUMMARY
          echo "- Code references (CODE_REF) validation" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation update check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-docs.outputs.needs_update }}" = "true" ]; then
            echo "âš ï¸ **Warning**: Documentation may need updates" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Documentation is up to date" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See job logs for detailed results." >> $GITHUB_STEP_SUMMARY
