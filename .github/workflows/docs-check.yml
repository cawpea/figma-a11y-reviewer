name: Documentation Check

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

jobs:
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆã‚³ãƒŸãƒƒãƒˆæ¯”è¼ƒã®ãŸã‚ï¼‰

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Validate CODE_REF references
        id: validate
        run: |
          echo "## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œè¨¼çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if npm run validate:docs; then
            echo "âœ… ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰å‚ç…§ãŒæœ‰åŠ¹ã§ã™" >> $GITHUB_STEP_SUMMARY
            echo "validate_result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ ã‚³ãƒ¼ãƒ‰å‚ç…§ã«ä¸æ•´åˆãŒã‚ã‚Šã¾ã™" >> $GITHUB_STEP_SUMMARY
            echo "validate_result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  check-docs-update:
    name: Check Documentation Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check for code changes
        id: code_changes
        run: |
          # mainãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã‚’ç¢ºèª
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

          echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          echo "$CHANGED_FILES"

          # ã‚³ãƒ¼ãƒ‰é–¢é€£ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          CODE_CHANGED=false

          for file in $CHANGED_FILES; do
            # backend, figma-plugin, sharedãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
            if [[ "$file" =~ ^(backend|figma-plugin|shared)/ ]] && [[ "$file" =~ \.(ts|tsx|js|jsx)$ ]]; then
              echo "ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œå‡º: $file"
              CODE_CHANGED=true
              break
            fi
          done

          echo "code_changed=$CODE_CHANGED" >> $GITHUB_OUTPUT
          echo "CODE_CHANGED=$CODE_CHANGED" >> $GITHUB_ENV

      - name: Generate documentation update report
        if: steps.code_changes.outputs.code_changed == 'true'
        run: |
          echo "## ğŸ“ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # dry-runãƒ¢ãƒ¼ãƒ‰ã§ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          node scripts/update-docs-from-commits.js --base=origin/main --dry-run --output=docs-update-report.md

          # ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã‚’GitHub Summaryã«è¿½åŠ 
          if [ -f docs-update-report.md ]; then
            cat docs-update-report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload documentation report
        if: steps.code_changes.outputs.code_changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: docs-update-report
          path: docs-update-report.md
          retention-days: 30

      - name: Check if documentation was updated
        if: steps.code_changes.outputs.code_changed == 'true'
        id: docs_check
        run: |
          # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé–¢é€£ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)

          DOCS_UPDATED=false

          for file in $CHANGED_FILES; do
            if [[ "$file" =~ ^(docs/|CLAUDE\.md|README\.md) ]] || [[ "$file" =~ \.md$ ]]; then
              echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ã‚’æ¤œå‡º: $file"
              DOCS_UPDATED=true
              break
            fi
          done

          echo "docs_updated=$DOCS_UPDATED" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$DOCS_UPDATED" = true ]; then
            echo "âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ›´æ–°ã•ã‚Œã¦ã„ã¾ã™" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  ã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`npm run update:docs:dry-run\` ã‚’å®Ÿè¡Œã—ã¦ã€å¿…è¦ãªæ›´æ–°ã‚’ç¢ºèªã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
            echo "- ä¸Šè¨˜ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
            echo "- å¿…è¦ã«å¿œã˜ã¦ CLAUDE.md ã‚„ docs/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ›´æ–°ã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR (if docs not updated)
        if: steps.code_changes.outputs.code_changed == 'true' && steps.docs_check.outputs.docs_updated == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let reportContent = '';
            if (fs.existsSync('docs-update-report.md')) {
              reportContent = fs.readFileSync('docs-update-report.md', 'utf8');
            }

            const comment = `## âš ï¸ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã®ç¢ºèª

            ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸãŒã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

            ### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

            ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ã®å¿…è¦æ€§ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

            \`\`\`bash
            npm run update:docs:dry-run
            \`\`\`

            ### è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆ

            <details>
            <summary>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º</summary>

            ${reportContent || 'ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ'}

            </details>

            ### å‚è€ƒãƒªãƒ³ã‚¯

            - [ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†ã‚¬ã‚¤ãƒ‰](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/development/documentation-management.md)
            - [ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½¿ã„æ–¹](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/development/scripts.md)            ---

            *ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ãŒä¸è¦ãªå ´åˆã¯ã€ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: No code changes detected
        if: steps.code_changes.outputs.code_changed == 'false'
        run: |
          echo "## ğŸ“ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸  ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Documentation Check Summary
    runs-on: ubuntu-latest
    needs: [validate-docs, check-docs-update]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "## ğŸ“Š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œè¨¼: ${{ needs.validate-docs.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- æ›´æ–°ç¢ºèª: ${{ needs.check-docs-update.result }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-docs.result }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
